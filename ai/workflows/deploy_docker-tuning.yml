name: AI Docker CI/CD

on:
  pull_request:
    types: [closed]
    branches:
    # - feature/docker-deploy
      - develop
    #  - main
  workflow_dispatch:
    inputs:
      env:
        description: "ë°°í¬ í™˜ê²½ ì„ íƒ"
        required: true
        default: "develop"
        type: choice
        options:
          - develop
          - main

env:
  BASE_IMAGE_NAME: base
  PROD_IMAGE_NAME: tuning-api

jobs:
  # CI ì‘ì—…: í…ŒìŠ¤íŠ¸ ë° ì´ë¯¸ì§€ ë¹Œë“œ
  ci:
    runs-on: ubuntu-latest
    steps:
      # 1. ì†ŒìŠ¤ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 1

      # 2. AWS ì¸ì¦
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v1
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      # 3. ECR ë¡œê·¸ì¸
      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v1

      # 4. íƒœê·¸ ì •ë³´ ìƒì„±
      - name: Generate tags
        id: generate-tags
        run: |
          BRANCH="${{ github.ref_name }}"
          SANITIZED_BRANCH="${BRANCH//\//-}"
          SANITIZED_BRANCH=$(echo "$SANITIZED_BRANCH" | sed 's#[^a-zA-Z0-9_.-]#-#g')
          BRANCH="$SANITIZED_BRANCH"
          SHORT_SHA=$(echo "${{ github.sha }}" | cut -c1-7)
          IMAGE_TAG="${BRANCH}-${SHORT_SHA}"

          if [ "$BRANCH" = "main" ]; then
            ENV_TAG="main-latest"
          else
            ENV_TAG="develop-latest"
          fi

          ECR_REGISTRY=${{ steps.login-ecr.outputs.registry }}
          REPOSITORY=tuning-api
          FULL_IMAGE="$ECR_REGISTRY/$REPOSITORY:$IMAGE_TAG"

          echo "branch=$BRANCH" >> $GITHUB_OUTPUT
          echo "short_sha=$SHORT_SHA" >> $GITHUB_OUTPUT
          echo "image_tag=$IMAGE_TAG" >> $GITHUB_OUTPUT
          echo "env_tag=$ENV_TAG" >> $GITHUB_OUTPUT
          echo "full_image=$FULL_IMAGE" >> $GITHUB_OUTPUT
          echo "ecr_registry=$ECR_REGISTRY" >> $GITHUB_OUTPUT
          echo "repository=$REPOSITORY" >> $GITHUB_OUTPUT

      # 5. Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ (ë¹Œë“œ ìºì‹œ í™œìš©)
      - name: Build and push Docker image with cache
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          REPOSITORY: tuning-api
          IMAGE_TAG: ${{ steps.generate-tags.outputs.image_tag }}
          ENV_TAG: ${{ steps.generate-tags.outputs.env_tag }}
        run: |
          echo "ğŸ—ï¸ Docker ì´ë¯¸ì§€ ë¹Œë“œ ì‹œì‘ (with cache)..."
          docker build \
            --cache-from=type=registry,ref=$ECR_REGISTRY/$REPOSITORY:$ENV_TAG \
            --cache-to=type=inline \
            -f Dockerfile.base-tuning \
            -t $ECR_REGISTRY/$REPOSITORY:$IMAGE_TAG \
            .
          docker tag $ECR_REGISTRY/$REPOSITORY:$IMAGE_TAG $ECR_REGISTRY/$REPOSITORY:$ENV_TAG
          echo "ğŸ“¤ Docker ì´ë¯¸ì§€ í‘¸ì‹œ ì¤‘..."
          docker push $ECR_REGISTRY/$REPOSITORY:$IMAGE_TAG
          docker push $ECR_REGISTRY/$REPOSITORY:$ENV_TAG

      # 6. ì„±ê³µ/ì‹¤íŒ¨ ì•Œë¦¼
      - name: Send success notification
        if: success()
        run: |
          curl -H "Content-Type: application/json" \
            -X POST \
            -d "{\"username\": \"AI CI\", \"content\": \"âœ… [AI CI ì„±ê³µ] **${{ steps.generate-tags.outputs.branch }}** ë¸Œëœì¹˜\\nğŸ”– íƒœê·¸: ${{ steps.generate-tags.outputs.image_tag }}\\nğŸ†” Commit: ${{ steps.generate-tags.outputs.short_sha }}\\nğŸ“¦ ì´ë¯¸ì§€: ${{ steps.generate-tags.outputs.full_image }}\"}" \
            ${{ secrets.DISCORD_WEBHOOK_PR_URL }}

      - name: Send failure notification
        if: failure()
        run: |
          curl -H "Content-Type: application/json" \
            -X POST \
            -d "{\"username\": \"AI CI\", \"content\": \"âŒ [AI CI ì‹¤íŒ¨] **${{ github.base_ref }}** ë¸Œëœì¹˜\\nğŸ”– Commit: ${{ github.sha }}\\nâš ï¸ ì›ì¸: ë¹Œë“œ ë˜ëŠ” í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨\"}" \
            ${{ secrets.DISCORD_WEBHOOK_PR_URL }}

    outputs:
      branch: ${{ steps.generate-tags.outputs.branch }}
      image_tag: ${{ steps.generate-tags.outputs.image_tag }}
      env_tag: ${{ steps.generate-tags.outputs.env_tag }}
      full_image: ${{ steps.generate-tags.outputs.full_image }}
      short_sha: ${{ steps.generate-tags.outputs.short_sha }}
      ecr_registry: ${{ steps.generate-tags.outputs.ecr_registry }}
      repository: ${{ steps.generate-tags.outputs.repository }}

  # CD ì‘ì—…: ë°°í¬
  cd:
    needs: ci
    runs-on: ubuntu-latest
    steps:
      # 1. AWS ì¸ì¦ (ECR ë° SSM ì ‘ê·¼)
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      # 2. ECR ë¡œê·¸ì¸
      - name: Login to Amazon ECR
        id: login-ecr-cd
        uses: aws-actions/amazon-ecr-login@v1

      # 3. CI output ë³€ìˆ˜ í™˜ê²½ì— ë°˜ì˜
      - name: Set CI output variables
        run: |
          CI_FULL_IMAGE="${{ needs.ci.outputs.full_image }}"
          CI_IMAGE_TAG="${{ needs.ci.outputs.image_tag }}"
          ECR_REGISTRY=${{ steps.login-ecr-cd.outputs.registry }}
          FULL_IMAGE="$ECR_REGISTRY/tuning-api:$CI_IMAGE_TAG"
          echo "ECR_REGISTRY=$ECR_REGISTRY" >> $GITHUB_ENV
          echo "FULL_IMAGE=$FULL_IMAGE" >> $GITHUB_ENV
          echo "IMAGE_TAG=$CI_IMAGE_TAG" >> $GITHUB_ENV

      # 4. SSMì—ì„œ í™˜ê²½ ë³€ìˆ˜/ì‹œí¬ë¦¿ ë¶ˆëŸ¬ì˜¤ê¸°
      - name: Set environment variables from SSM
        id: ssm
        run: |
          load_param() {
            VALUE=$(aws ssm get-parameter --name "$1" --with-decryption --query "Parameter.Value" --output text)
            echo "::add-mask::$VALUE"
            echo "$2=$VALUE" >> $GITHUB_ENV
          }
          load_secret_to_file() {
            VALUE=$(aws ssm get-parameter --name "$1" --with-decryption --output json | jq -r .Parameter.Value)
            echo "$VALUE" | while IFS= read -r line; do echo "::add-mask::$line"; done
            echo "$VALUE" > "$2"
          }
          BRANCH="${{ github.ref_name }}"
          if [[ "$BRANCH" == "main" ]]; then
            echo "ENV=production" >> $GITHUB_ENV
            load_param "/global/gcp/PROD_GCP_HOST_AI" HOST
            load_param "/global/gcp/PROD_GCP_INSTANCE_AI" INSTANCE
            load_param "/global/gcp/PROD_GCP_PROJECT_ID" PROJECT_ID
            load_param "/global/gcp/PROD_GCP_ZONE" ZONE
            load_secret_to_file "/global/gcp/PROD_GCP_SA_KEY" gcp-sa-key.json
          elif [[ "$BRANCH" == "develop" ]]; then
            echo "ENV=develop" >> $GITHUB_ENV
            load_param "/global/gcp/DEV_GCP_HOST_AI" HOST
            load_param "/global/gcp/DEV_GCP_INSTANCE_AI" INSTANCE
            load_param "/global/gcp/DEV_GCP_PROJECT_ID" PROJECT_ID
            load_param "/global/gcp/DEV_GCP_ZONE" ZONE
            load_secret_to_file "/global/gcp/DEV_GCP_SA_KEY" gcp-sa-key.json
          else
            echo "ENV=develop" >> $GITHUB_ENV
            load_param "/global/gcp/DEV_GCP_HOST_AI_TEST" HOST
            load_param "/global/gcp/DEV_GCP_INSTANCE_AI_TEST" INSTANCE
            load_param "/global/gcp/DEV_GCP_PROJECT_ID" PROJECT_ID
            load_param "/global/gcp/DEV_GCP_ZONE_TEST" ZONE
            load_secret_to_file "/global/gcp/DEV_GCP_SA_KEY" gcp-sa-key.json
          fi
          echo "SA_KEY<<EOF" >> $GITHUB_ENV
          cat gcp-sa-key.json >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV
          load_param "/global/gcp/SSH_USERNAME" SSH_USERNAME
          load_secret_to_file "/global/gcp/SSH_PRIVATE_KEY" id_rsa
          chmod 600 id_rsa
          echo "SSH_KEY_PATH=id_rsa" >> $GITHUB_ENV

      # 5. GCP ì¸ì¦ (ì˜µì…˜: í•„ìš”ì‹œ í™˜ê²½ ë¶„ë¦¬)
      - name: Authenticate to GCP
        uses: google-github-actions/auth@v1
        with:
          credentials_json: ${{ env.SA_KEY }}

      - name: Setup gcloud CLI
        uses: google-github-actions/setup-gcloud@v1

      # 6. GCP ì¸ìŠ¤í„´ìŠ¤ ë¶€íŒ… (ì¤‘ì§€ ìƒíƒœ â†’ ì‹œì‘/Resume)
      - name: Boot target instance (start/resume with conditional wait)
        run: |
          STATUS=$(gcloud compute instances describe "$INSTANCE" --zone="$ZONE" --format='get(status)')
          echo "ğŸ” í˜„ì¬ ìƒíƒœ: $STATUS"
          if [[ "$STATUS" == "SUSPENDED" ]]; then
            echo "ğŸ”„ 'resume' ëª…ë ¹ ì‹¤í–‰"
            gcloud compute instances resume "$INSTANCE" --zone="$ZONE"
            sleep 30
          elif [[ "$STATUS" == "TERMINATED" ]]; then
            echo "ğŸ”„ 'start' ëª…ë ¹ ì‹¤í–‰"
            gcloud compute instances start "$INSTANCE" --zone="$ZONE"
            sleep 30
          else
            echo "âœ… ì´ë¯¸ ì‹¤í–‰ ì¤‘"
          fi
      # 1. ì†ŒìŠ¤ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 1
      
      - name: Copy docker-compose-tuning.yml to server
        uses: appleboy/scp-action@v0.1.4
        with:
          host: ${{ env.HOST }}
          username: ${{ env.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: "docker-compose-tuning.yml"  # ğŸ”¹ ë£¨íŠ¸ ê¸°ì¤€ ìƒëŒ€ê²½ë¡œ
          target: "/home/deploy"

      # 7. ì‹¤ì œ ë°°í¬ + í—¬ìŠ¤ì²´í¬ + ë¡¤ë°± (Prodë§Œ)
      - name: Deploy to GCP & Health check (with rollback)
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ env.HOST }}
          username: ${{ env.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          envs: ENV,FULL_IMAGE,IMAGE_TAG,AWS_REGION,ECR_REGISTRY,AWS_ACCESS_KEY_ID,AWS_SECRET_ACCESS_KEY
          script: |
            echo "=== í™˜ê²½ë³€ìˆ˜ í™•ì¸ ==="
            echo "ENV: $ENV"
            echo "IMAGE_TAG: $IMAGE_TAG"
            echo "FULL_IMAGE: $FULL_IMAGE"
            echo "AWS_REGION: $AWS_REGION"
            echo "ECR_REGISTRY: $ECR_REGISTRY"
            echo "========================"
            cd /home/deploy

            # AWS CLI ì„¤ì • (ì„ì‹œ ì¸ì¦)
            mkdir -p ~/.aws
            cat > ~/.aws/credentials << EOF
            [default]
            aws_access_key_id=${AWS_ACCESS_KEY_ID}
            aws_secret_access_key=${AWS_SECRET_ACCESS_KEY}
            EOF
            cat > ~/.aws/config << EOF
            [default]
            region=${AWS_REGION}
            output=json
            EOF

            # ë³¼ë¥¨ì— sentence-transformers íŒ¨í‚¤ì§€ ìë™ ì„¤ì¹˜ (ì—†ì„ ë•Œë§Œ)
            PYLIBS_DIR="/home/deploy/app-pylibs"
            if [ ! -d "$PYLIBS_DIR/sentence_transformers" ]; then
              echo "ğŸ“¦ sentence-transformers íŒ¨í‚¤ì§€ê°€ ì—†ìœ¼ë¯€ë¡œ ì„¤ì¹˜í•©ë‹ˆë‹¤..."
              mkdir -p "$PYLIBS_DIR"
              pip install --upgrade pip
              pip install --target="$PYLIBS_DIR" sentence-transformers==4.1.0
            else
              echo "âœ… sentence-transformers íŒ¨í‚¤ì§€ê°€ ì´ë¯¸ ì¡´ì¬í•©ë‹ˆë‹¤."
            fi

            # ChromaDB PM2 ìƒíƒœ í™•ì¸
            if ! pm2 status chromadb | grep -q "online"; then
              echo "ChromaDBê°€ ì‹¤í–‰ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. PM2ë¥¼ í†µí•´ ì‹œì‘ ì¤‘..."
              pm2 start ecosystem.config.js --only chromadb
            else
              echo "ChromaDBëŠ” ì´ë¯¸ ì‹¤í–‰ ì¤‘ì…ë‹ˆë‹¤."
            fi

            # ECR ë¡œê·¸ì¸
            echo "ğŸ” ECR ë¡œê·¸ì¸ ì‹œë„"
            if aws ecr get-login-password --region $AWS_REGION | docker login --username AWS --password-stdin $ECR_REGISTRY; then
              echo "âœ… ECR ë¡œê·¸ì¸ ì„±ê³µ"
            else
              echo "âŒ ECR ë¡œê·¸ì¸ ì‹¤íŒ¨"
              exit 1
            fi
            
            #Production í™˜ê²½ì—ì„œëŠ”CPU ì œí•œ 3.5ë¡œ ì„¤ì •
            if [ "$ENV" = "production" ] || [ "$ENV" = "prod" ]; then
              CPU_LIMIT=3.5
            else
              CPU_LIMIT=2.0
            fi

            # .env íŒŒì¼ì— ì´ë¯¸ì§€ ì •ë³´ ì„¸íŒ…
            echo "# ì´ë¯¸ì§€ ì„¤ì •" > .env
            echo "FULL_IMAGE=${FULL_IMAGE}" >> .env
            echo "CPU_LIMIT=${CPU_LIMIT}" >> .env

            # ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì¤‘ì§€/ì‚­ì œ í›„ ìµœì‹  ì´ë¯¸ì§€ë¡œ ì‹¤í–‰


            if [ ! -d "/home/deploy/models/jhgan-ko-sbert-nli" ]; then
              echo "ëª¨ë¸ ë””ë ‰í† ë¦¬ê°€ ì—†ìŠµë‹ˆë‹¤. ëª¨ë¸ì„ ë¨¼ì € ë‹¤ìš´ë¡œë“œí•©ë‹ˆë‹¤."
              docker compose -f docker-compose-tuning run --rm tuning python scripts/download_model.py
            else
              echo "ëª¨ë¸ ë””ë ‰í† ë¦¬ê°€ ì´ë¯¸ ì¡´ì¬í•©ë‹ˆë‹¤. ë‹¤ìš´ë¡œë“œë¥¼ ê±´ë„ˆëœë‹ˆë‹¤."
            fi            
            docker compose -f docker-compose-tuning.yml stop tuning
            docker compose -f docker-compose-tuning.yml rm -f tuning
            docker compose --env-file .env -f docker-compose-tuning.yml up -d tuning

            echo "ğŸ•’ FastAPI ì„œë²„ ê¸°ë™ ëŒ€ê¸° ì¤‘..."
            sleep 15

            # ================== Health Check + íƒœê·¸ ê¸°ë¡ + ë¡¤ë°± (Prodë§Œ) ==================
             # ìµœì´ˆ ë¡¤ë°± ëŒ€ë¹„: íŒŒì¼ì´ ì—†ìœ¼ë©´ ë¹ˆ íŒŒì¼ ìƒì„±(ìµœì´ˆ ë°°í¬, ë˜ëŠ” ìˆ˜ë™ ë³µêµ¬ ëŒ€ë¹„)
            [ -f last-successful-tag.txt ] || touch last-successful-tag.txt
            echo "ğŸ” API ì„œë¹„ìŠ¤ í—¬ìŠ¤ì²´í¬ ì¤‘..."
            for i in {1..5}; do
             if curl -sf http://localhost:8000/api/v1/health; then
                echo "âœ… API ì„œë¹„ìŠ¤ê°€ ì •ìƒì ìœ¼ë¡œ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤."
                echo "$IMAGE_TAG" > last-successful-tag.txt
                # ChromaDB ì—°ê²° í™•ì¸(ê²½ê³ ë§Œ)
                echo "ğŸ” ChromaDB ì—°ê²° ìƒíƒœ í™•ì¸ ì¤‘..."
                if curl -sf http://localhost:8000/api/v1/health/chromadb; then
                  echo "âœ… ChromaDBê°€ ì •ìƒì ìœ¼ë¡œ ì‘ë™ ì¤‘ì…ë‹ˆë‹¤."
                else
                  echo "âš ï¸ ê²½ê³ : ChromaDB ì—°ê²°ì„ í™•ì¸í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
                fi
                exit 0
              fi
              echo "â±ï¸ API ì„œë¹„ìŠ¤ ì¤€ë¹„ ëŒ€ê¸° ì¤‘... ($i/5)"
              sleep 10
            done

            if [ "$ENV" = "production" ] || [ "$ENV" = "prod" ]; then
              echo "ğŸŸ  [PRODUCTION] í™˜ê²½ì´ë¯€ë¡œ í—¬ìŠ¤ì²´í¬ ì‹¤íŒ¨ ì‹œ ë¡¤ë°± ìˆ˜í–‰!"
              PREV_IMAGE_TAG=$(cat last-successful-tag.txt)
              PREV_IMAGE="${ECR_REGISTRY}/tuning-api:${PREV_IMAGE_TAG}"
              if grep -q '^FULL_IMAGE=' .env; then
                sed -i "s|^FULL_IMAGE=.*|FULL_IMAGE=${PREV_IMAGE}|" .env
              else
                echo "FULL_IMAGE=${PREV_IMAGE}" >> .env
              fi
              
              docker compose -f docker-compose-tuning.yml stop tuning
              docker compose -f docker-compose-tuning.yml rm -f tuning
              docker compose --env-file .env -f docker-compose-tuning.yml up -d tuning
              echo "âœ… ë¡¤ë°± ì™„ë£Œ! (ì´ì „ ì´ë¯¸ì§€ë¡œ ë³µêµ¬ë¨)"
            else
              echo "ğŸŸ¢ [DEVELOP/í…ŒìŠ¤íŠ¸] í™˜ê²½ì´ë¯€ë¡œ ë¡¤ë°±í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤."
            fi

            echo "ğŸ“ ìµœê·¼ ë¡œê·¸ í™•ì¸:"
            docker compose -f docker-compose-tuning.yml logs --tail=10 tuning
            #ì‹¤íŒ¨
            exit 1

      # 8. ì„±ê³µ/ì‹¤íŒ¨ ì•Œë¦¼
      - name: Send success notification
        if: success()
        run: |
          curl -H "Content-Type: application/json" \
            -X POST \
            -d "{\"content\": \"âœ… [AI CD ì„±ê³µ] **${{ env.ENV }}** í™˜ê²½ ë°°í¬ ì™„ë£Œ\\nğŸ”– ì´ë¯¸ì§€: ${{ env.FULL_IMAGE }}\\nâš™ï¸ API ì„œë¹„ìŠ¤ë§Œ ì¬ì‹œì‘ (ChromaDB ìœ ì§€)\"}" \
            ${{ secrets.DISCORD_WEBHOOK_PR_URL }}

      - name: Send failure notification
        if: failure()
        run: |
          WORKFLOW_URL="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          curl -H "Content-Type: application/json" \
            -X POST \
            -d "{\"content\": \"âŒ [AI CD ì‹¤íŒ¨] **${{ env.ENV }}** í™˜ê²½ ë°°í¬ ì‹¤íŒ¨\\nğŸ”– ì´ë¯¸ì§€: ${{ env.FULL_IMAGE }}\\nâš ï¸ ì›ì¸: API ë°°í¬ ê³¼ì • ì¤‘ ì˜¤ë¥˜ ë°œìƒ\\nğŸ”— [ì›Œí¬í”Œë¡œìš° ë¡œê·¸]($WORKFLOW_URL)\"}" \
            ${{ secrets.DISCORD_WEBHOOK_PR_URL }}