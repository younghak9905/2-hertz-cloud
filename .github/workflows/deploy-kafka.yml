name: Deploy KAFKA

on:
  workflow_dispatch:
    inputs:
      restart:
        description: "KAFKAë¥¼ ìž¬ì‹œìž‘í• ê¹Œìš”?"
        required: false
        default: "false"
        type: choice
        options:
          - "false"
          - "true"
jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v1
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Login to ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v1
      
      - name: Set environment variables from SSM
        run: |
          load_param() {
            VALUE=$(aws ssm get-parameter --name "$1" --with-decryption --query "Parameter.Value" --output text)
            echo "::add-mask::$VALUE"
            echo "$2=$VALUE" >> $GITHUB_ENV
          }

          load_secret_to_file() {
            VALUE=$(aws ssm get-parameter --name "$1" --with-decryption --output json | jq -r .Parameter.Value)

            echo "$VALUE" | while IFS= read -r line; do
              echo "::add-mask::$line"
            done

            echo "$VALUE" > "$2"
          }
          BRANCH="develop"  # ê°œë°œ í™˜ê²½ì„ ìœ„í•œ ë¸Œëžœì¹˜ ì„¤ì •
          SANITIZED_BRANCH="${BRANCH//\//-}"
          SANITIZED_BRANCH=$(echo "$SANITIZED_BRANCH" | sed 's#[^a-zA-Z0-9_.-]#-#g')
          BRANCH="$SANITIZED_BRANCH"
          echo "BRANCH=$BRANCH" >> $GITHUB_ENV
          echo "ENV=develop" >> $GITHUB_ENV
          load_param "/global/gcp/kafka/HOST" HOST
          load_param "/global/gcp/kafka/INSTANCE" INSTANCE
          load_param "/global/gcp/kafka/PROJECT_ID" PROJECT_ID
          load_param "/global/gcp/kafka/ZONE" ZONE
          load_secret_to_file "/global/gcp/kafka/SA_KEY" gcp-sa-key.json
          echo "SA_KEY<<EOF" >> $GITHUB_ENV
          cat gcp-sa-key.json >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: Authenticate to GCP KAFKA
        if: github.event.inputs.target == 'KAFKA' 
        uses: google-github-actions/auth@v1
        with:
            credentials_json: ${{ env.SA_KEY }}

      - name: Setup gcloud CLI
        uses: google-github-actions/setup-gcloud@v1

      - name: Boot target instance (start/resume with conditional wait)
        run: |
          echo "âš¡ ì¸ìŠ¤í„´ìŠ¤ ìƒíƒœ í™•ì¸ ì¤‘: $INSTANCE (zone: $ZONE)"
          STATUS=$(gcloud compute instances describe "$INSTANCE" --zone="$ZONE" --format='get(status)')
          echo "ðŸ”Ž í˜„ìž¬ ìƒíƒœ: $STATUS"

          if [[ "$STATUS" == "SUSPENDED" ]]; then
            echo "ðŸ”„ 'resume' ëª…ë ¹ ì‹¤í–‰"
            gcloud compute instances resume "$INSTANCE" --zone="$ZONE"
            echo "â³ ìƒíƒœ ë³€ê²½ í›„ 30ì´ˆ ëŒ€ê¸°..."
            sleep 30
          elif [[ "$STATUS" == "TERMINATED" ]]; then
            echo "ðŸ”„ 'start' ëª…ë ¹ ì‹¤í–‰"
            gcloud compute instances start "$INSTANCE" --zone="$ZONE"
            echo "â³ ìƒíƒœ ë³€ê²½ í›„ 30ì´ˆ ëŒ€ê¸°..."
            sleep 30
          else
            if [[ "${{ inputs.restart }}" == "true" ]]; then
                echo "ðŸ”„ 'stop' ëª…ë ¹ ì‹¤í–‰"
                gcloud compute instances stop "$INSTANCE" --zone="$ZONE"
                echo "â³ ìƒíƒœ ë³€ê²½ í›„ 30ì´ˆ ëŒ€ê¸°..."
                sleep 60
                echo "ðŸ”„ 'start' ëª…ë ¹ ì‹¤í–‰"
                gcloud compute instances start "$INSTANCE" --zone="$ZONE"
                echo "â³ ìƒíƒœ ë³€ê²½ í›„ 30ì´ˆ ëŒ€ê¸°..."
                sleep 30
                fi
            echo "âœ… ì´ë¯¸ ì‹¤í–‰ ì¤‘ - ëŒ€ê¸° ìƒëžµ"
          fi

      - name: Wait for KAFKA to be ready
        run: |
          echo "ðŸ•’ Spring Boot ì„œë²„ ê¸°ë™ ëŒ€ê¸° ì¤‘..."
          sleep 30

      - name: Send success notification
        if: success()
        run: |
            curl -H "Content-Type: application/json" \
                 -X POST \
                 -d "{\"content\": \"kafka ë°°í¬ ì™„ë£Œ\n> \"}" \
                 ${{ secrets.DISCORD_WEBHOOK_CICD_URL }}
    
      - name: Send failure notification
        if: failure()
        run: |
            curl -H "Content-Type: application/json" \
                 -X POST \
                 -d "{\"content\": \"kafka ë°°í¬ ì‹¤íŒ¨\n> \"}" \
                 ${{ secrets.DISCORD_WEBHOOK_CICD_URL }}
