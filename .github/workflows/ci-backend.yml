# .github/workflows/backend-ci.yml

name: Backend CI

### ìŠ¤í¬ë¦½íŠ¸ ë¹„í™œì„±í™”ë¥¼ ìœ„í•œ íŠ¸ë¦¬ê±°
on: # í™œì„±í™” ì‹œ ì‚­ì œ
  push: # í™œì„±í™” ì‹œ ì‚­ì œ
    branches: # í™œì„±í™” ì‹œ ì‚­ì œ
      - _never_run_this_branch # í™œì„±í™” ì‹œ ì‚­ì œ

      # on:
#   pull_request:
#     types: [closed] # PRì´ ë‹«í˜”ì„ ë•Œ (ë³‘í•© í¬í•¨)
#     branches:
#       - main # main ë¸Œëœì¹˜ë¡œ Merge ì‹œ -> Production í™˜ê²½ì— ë°°í¬
#       - develop # develop ë¸Œëœì¹˜ë¡œ Merge ì‹œ -> DEV í™˜ê²½ì— ë°°í¬

jobs:
  backend-ci:
    runs-on: ubuntu-latest  # GitHub Actionsì˜ ì‹¤í–‰ í™˜ê²½(OS)

    steps:
    # 1. ì†ŒìŠ¤ ì½”ë“œ ì²´í¬ì•„ì›ƒ
    - name: Checkout repository
      uses: actions/checkout@v3
  

    # 2. Java 21 ì„¤ì¹˜ (Spring Boot 3.x ê¸°ì¤€)
    - name: Set up JDK
      uses: actions/setup-java@v3
      with:
        java-version: '21'
        distribution: 'temurin'
        cache: 'gradle'

    # 3. Gradle ìºì‹œ ì ìš© (ë¹Œë“œ ì‹œê°„ ë‹¨ì¶•)
    - name: Cache Gradle
      uses: actions/cache@v3
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
          ~/.gradle/buildOutputCleanup
          build/
        key: gradle-${{ runner.os }}-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          gradle-${{ runner.os }}-
          gradle-

     # 4. ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ ì‹¤í–‰ (ëª¨ë“  PRì—ì„œ ì‹¤í–‰)
    - name: Run Unit Tests
      run: ./gradlew test --no-daemon --parallel --max-workers=2 --stacktrace
      env:
        GRADLE_OPTS: -Dorg.gradle.daemon=false -Dorg.gradle.parallel=true -Dorg.gradle.workers.max=2

    # 5. í†µí•© í…ŒìŠ¤íŠ¸ ì‹¤í–‰ (main ë¸Œëœì¹˜ PRì—ì„œë§Œ ì‹¤í–‰)
    - name: Run Integration Tests
      if: github.base_ref == 'main'
      run: ./gradlew integrationTest --no-daemon --parallel --max-workers=2 --stacktrace
      env:
        GRADLE_OPTS: -Dorg.gradle.daemon=false -Dorg.gradle.parallel=true -Dorg.gradle.workers.max=2
      continue-on-error: false

    # 6. ì• í”Œë¦¬ì¼€ì´ì…˜ ë¹Œë“œ
    - name: Build Spring Boot Application
      if: success()
      run: ./gradlew build -x test -x integrationTest --no-daemon --parallel --max-workers=2
      env:
        GRADLE_OPTS: -Dorg.gradle.daemon=false -Dorg.gradle.parallel=true -Dorg.gradle.workers.max=2
        # MySQL ì„¤ì •
        DB_HOST: ${{ secrets.DB_HOST }}
        DB_PORT: ${{ secrets.DB_PORT }}
        DB_NAME: ${{ secrets.DB_NAME }}
        DB_USERNAME: ${{ secrets.DB_USERNAME }}
        DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
        # Redis ì„¤ì •
        REDIS_HOST: ${{ secrets.REDIS_HOST }}
        REDIS_PORT: ${{ secrets.REDIS_PORT }}
        REDIS_PASSWORD: ${{ secrets.REDIS_PASSWORD }}
        # JWT ì„¤ì •
        JWT_SECRET: ${{ secrets.JWT_SECRET }}
        # Swagger ì„¤ì •
        SWAGGER_ENABLED: ${{ github.base_ref == 'main' && 'false' || 'true' }}
        # Kakao ì„¤ì •
        KAKAO_CLIENT_ID: ${{ secrets.KAKAO_CLIENT_ID }}
        REDIRECT_URL: ${{ secrets.REDIRECT_URL }}
        # AI ì„œë²„ ì„¤ì •
        AI_SERVER_IP: ${{ secrets.AI_SERVER_IP }}
        # ë¹Œë“œ ë©”íƒ€ë°ì´í„°
        BUILD_NUMBER: ${{ github.run_number }}
        GIT_COMMIT: ${{ github.sha }}

    # 8. Discordë¡œ CI ê²°ê³¼ ì „ì†¡ (ì„±ê³µ/ì‹¤íŒ¨ì— ë”°ë¼ ë‹¤ë¥¸ ë©”ì‹œì§€ ì „ì†¡)
    - name: Send success notification
      if: success()
      run: |
        curl -H "Content-Type: application/json" \
             -X POST \
             -d "{\"username\": \"Backend CI\", \"content\": \"âœ… [BE CI ì„±ê³µ] **${{ env.ENV }}** Backend ì„œë²„ (ë¸Œëœì¹˜: \`${{ env.BRANCH }}\`)\\nğŸ”– Commit: ${{ env.COMMIT_HASH }}\"}" \
             ${{ secrets.DISCORD_WEBHOOK_URL }}

    - name: Send failure notification
      if: failure()
      run: |
        curl -H "Content-Type: application/json" \
             -X POST \
             -d "{\"username\": \"Backend CI\", \"content\": \"âŒ [BE CI ì‹¤íŒ¨] **${{ env.ENV }}** Backend ì„œë²„ (ë¸Œëœì¹˜: \`${{ env.BRANCH }}\`)\\nğŸ”– Commit: ${{ env.COMMIT_HASH }}\\nâš ï¸ ì›ì¸: ì›Œí¬í”Œë¡œìš° ì‹¤í–‰ ì¤‘ ì˜¤ë¥˜ ë°œìƒ\"}" \
             ${{ secrets.DISCORD_WEBHOOK_URL }}
