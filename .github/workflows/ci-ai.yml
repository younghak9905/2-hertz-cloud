# .github/workflows/fastapi-ai-ci.yml

name: AI CI

### ìŠ¤í¬ë¦½íŠ¸ ë¹„í™œì„±í™”ë¥¼ ìœ„í•œ íŠ¸ë¦¬ê±°
on: # í™œì„±í™” ì‹œ ì‚­ì œ
  push: # í™œì„±í™” ì‹œ ì‚­ì œ
    branches: # í™œì„±í™” ì‹œ ì‚­ì œ
      - _never_run_this_branch # í™œì„±í™” ì‹œ ì‚­ì œ

      # on:
#   pull_request:
#     types: [closed] # PRì´ ë‹«í˜”ì„ ë•Œ (ë³‘í•© í¬í•¨)
#     branches:
#       - main # main ë¸Œëœì¹˜ë¡œ Merge ì‹œ -> Production í™˜ê²½ì— ë°°í¬
#       - develop # develop ë¸Œëœì¹˜ë¡œ Merge ì‹œ -> DEV í™˜ê²½ì— ë°°í¬
jobs:
  ai-ci:
    runs-on: ubuntu-latest

    steps:
    # 1. ì†ŒìŠ¤ ì½”ë“œ ì²´í¬ì•„ì›ƒ
    - name: Checkout repository
      uses: actions/checkout@v3
      with:
        fetch-depth: 1

    # 2. Python 3.10 ì„¤ì¹˜ ë° ìºì‹œ ì„¤ì •
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        cache: 'pip'
        cache-dependency-path: |
          requirements.txt
          requirements-dev.txt

    # 3. ê°€ìƒí™˜ê²½ ìƒì„± ë° í™œì„±í™”
    - name: Create and activate virtual environment
      run: |
        python -m venv venv
        source venv/bin/activate

    # 4. ì˜ì¡´ì„± ì„¤ì¹˜ (ë³‘ë ¬ ì²˜ë¦¬ ë° ìºì‹œ í™œìš©)
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        # requirements.txt ì„¤ì¹˜ (ì—†ìœ¼ë©´ ê±´ë„ˆëœ€)
        pip install -r requirements.txt || echo "ğŸ“¦ requirements.txt ì—†ìŒ, ê±´ë„ˆëœ€"
        # requirements-dev.txt ì„¤ì¹˜ (ì—†ìœ¼ë©´ ê±´ë„ˆëœ€)
        pip install -r requirements-dev.txt || echo "ğŸ“¦ requirements-dev.txt ì—†ìŒ, ê±´ë„ˆëœ€"
        # ê¸°ë³¸ ì˜ì¡´ì„± ì„¤ì¹˜ (í•œ ë²ˆì— ì„¤ì¹˜)
        pip install "pydantic[email]" fastapi uvicorn transformers torch pytest pytest-asyncio httpx


    # 5. Discord ì•Œë¦¼
    - name: Send success notification
      if: success()
      run: |
        curl -H "Content-Type: application/json" \
             -X POST \
             -d "{\"username\": \"AI CI\", \"content\": \"âœ… [AI CI ì„±ê³µ] **${{ github.base_ref }}** AI ì„œë²„ (ë¸Œëœì¹˜: \`${{ github.head_ref }}\`)\\nğŸ”– Commit: ${{ github.sha }}\"}" \
             ${{ secrets.DISCORD_WEBHOOK_URL }}

    - name: Send failure notification
      if: failure()
      run: |
        curl -H "Content-Type: application/json" \
             -X POST \
             -d "{\"username\": \"AI CI\", \"content\": \"âŒ [AI CI ì‹¤íŒ¨] **${{ github.base_ref }}** AI ì„œë²„ (ë¸Œëœì¹˜: \`${{ github.head_ref }}\`)\\nğŸ”– Commit: ${{ github.sha }}\\nâš ï¸ [ì›Œí¬í”Œë¡œìš° ë¡œê·¸ ë³´ê¸°]($WORKFLOW_URL)\"}" \
             ${{ secrets.DISCORD_WEBHOOK_URL }}
