name: Rollback BE Deploy

on:
  workflow_call:
    inputs:
      environment: # ê°’: "production" ë˜ëŠ” "stage"
        description: "ëŒ€ìƒ í™˜ê²½"
        required: true
        type: string

jobs:
  rollback:
    runs-on: ubuntu-latest

    steps:
      - name: Set environment variables
        run: |
          echo "ENVIRONMENT=${{ inputs.environment }}" >> $GITHUB_ENV
          echo "HOST=${{ inputs.environment == 'production' && secrets.PROD_SERVER_HOST || secrets.STAGING_SERVER_HOST }}" >> $GITHUB_ENV

      - name: Authenticate to GCP
        if: ${{ inputs.environment == 'production' }}
        uses: google-github-actions/auth@v1
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Authenticate to GCP (Stage)
        if: ${{ inputs.environment != 'production' }}
        uses: google-github-actions/auth@v1
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY_STAGING }}

      - name: SSH into server and rollback
        uses: appleboy/ssh-action@master
        with:
          host: ${{ env.HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            cd /home/deploy
            ./be_deploy.sh --rollback || exit 1

      - name: Health check with retries
        env:
          HOST: ${{ env.HOST }}
          ENVIRONMENT: ${{ env.ENVIRONMENT }}
        run: |
          echo "(Rollback) ğŸ” í—¬ìŠ¤ì²´í¬ ì‹œì‘: ìµœëŒ€ 3íšŒ ì‹œë„í•©ë‹ˆë‹¤."

          if [[ "$ENVIRONMENT" == "production" ]]; then
            CHECK_URL="https://hertz-tuning.com/api/ping"
          else
            CHECK_URL="http://${HOST}:8080/api/ping"
          fi

          for i in {1..3}; do
            echo "â±ï¸ ì‹œë„ $i: $CHECK_URL"
            if curl -sf "$CHECK_URL"; then
              echo "(Rollback) âœ… í—¬ìŠ¤ì²´í¬ ì„±ê³µ ğŸ‰"
              exit 0
            else
              echo "::error::í—¬ìŠ¤ì²´í¬ ì‹œë„ $i ì‹¤íŒ¨"
              sleep 15
            fi
          done

          echo "::error::(Rollback) âŒ 3íšŒ í—¬ìŠ¤ì²´í¬ ì‹¤íŒ¨ - ì„œë²„ê°€ ì •ìƒ ê¸°ë™ë˜ì§€ ì•ŠìŒ"
          exit 1

      - name: Send success notification
        if: success()
        run: |
          curl -H "Content-Type: application/json" \
            -X POST \
            -d "{\"content\": \"âœ… [BE ë¡¤ë°± ì™„ë£Œ] \`${{ inputs.environment }}\` í™˜ê²½\"}" \
            ${{ secrets.DISCORD_WEBHOOK_CICD_URL }}

      - name: Send failure notification
        if: failure()
        run: |
          curl -H "Content-Type: application/json" \
            -X POST \
            -d "{\"content\": \"âŒ [BE ë¡¤ë°± ì‹¤íŒ¨] \`${{ inputs.environment }}\` í™˜ê²½\"}" \
            ${{ secrets.DISCORD_WEBHOOK_CICD_URL }}
