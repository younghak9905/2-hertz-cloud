# .github/workflows/frontend-ci.yml

name: Frontend CI

### ìŠ¤í¬ë¦½íŠ¸ ë¹„í™œì„±í™”ë¥¼ ìœ„í•œ íŠ¸ë¦¬ê±°
on: # í™œì„±í™” ì‹œ ì‚­ì œ
  push: # í™œì„±í™” ì‹œ ì‚­ì œ
    branches: # í™œì„±í™” ì‹œ ì‚­ì œ
      - _never_run_this_branch # í™œì„±í™” ì‹œ ì‚­ì œ

      # on:
#   pull_request:
#     types: [closed] # PRì´ ë‹«í˜”ì„ ë•Œ (ë³‘í•© í¬í•¨)
#     branches:
#       - main # main ë¸Œëœì¹˜ë¡œ Merge ì‹œ -> Production í™˜ê²½ì— ë°°í¬
#       - develop # develop ë¸Œëœì¹˜ë¡œ Merge ì‹œ -> DEV í™˜ê²½ì— ë°°í¬

jobs:
  frontend-ci:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
        cache: 'npm'  # npm ìºì‹œ í™œì„±í™”

    # npm ìºì‹œ ìµœì í™”
    - name: Cache npm dependencies
      uses: actions/cache@v3
      id: npm-cache
      with:
        path: ~/.npm
        key: ${{ runner.os }}-npm-${{ hashFiles('**/package-lock.json') }}
        restore-keys: |
          ${{ runner.os }}-npm-

    # Next.js ë¹Œë“œ ìºì‹œ
    - name: Cache Next.js build
      uses: actions/cache@v3
      id: nextjs-cache
      with:
        path: |
          .next/cache
        key: ${{ runner.os }}-nextjs-${{ hashFiles('**/package-lock.json') }}
        restore-keys: |
          ${{ runner.os }}-nextjs-

    - name: Install dependencies
      if: steps.npm-cache.outputs.cache-hit != 'true'
      run: npm ci

#    - name: Run Unit Tests (Jest)
#      run: npm run test

    - name: Build Next.js App
      env:
        NEXT_PUBLIC_API_BASE_URL: ${{ secrets.NEXT_PUBLIC_API_BASE_URL }}
      run: npm run build

#    # 6. ë¹Œë“œ ê²°ê³¼ ì•„í‹°íŒ©íŠ¸ ì—…ë¡œë“œ (.next í´ë”)
#    - name: Upload .next Build Artifact
#      uses: actions/upload-artifact@v3
#      with:
#        name: nextjs-app
#        path: .next

    # 7. Discord ì•Œë¦¼ ì „ì†¡ (ì„±ê³µ/ì‹¤íŒ¨ ê´€ê³„ì—†ì´ í•­ìƒ ì‹¤í–‰ë¨)
    - name: Send success notification
      if: success()
      run: |
       curl -H "Content-Type: application/json" \
       -X POST \
       -d "{\"content\": \"${{ env.DEPLOY_MESSAGE }} **${{ env.ENV }}** Fronted ì„œë²„ (ë¸Œëœì¹˜: \`${{ env.BRANCH }}\`)\\nğŸ”– Commit: ${{ env.COMMIT_HASH }}\"}" \
       ${{ secrets.DISCORD_WEBHOOK_CICD_URL }}

    - name: Send failure notification
      if: failure()
      run: |
       curl -H "Content-Type: application/json" \
       -X POST \
       -d "{\"content\": \"âŒ [FE CI ì‹¤íŒ¨] **${{ env.ENV }}** AI ì„œë²„ (ë¸Œëœì¹˜: \`${{ env.BRANCH }}\`)\\nğŸ”– Commit: ${{ env.COMMIT_HASH }}\\nâš ï¸ [ì›Œí¬í”Œë¡œìš° ë¡œê·¸ ë³´ê¸°]($WORKFLOW_URL)\"}" \
       ${{ secrets.DISCORD_WEBHOOK_CICD_URL }}
