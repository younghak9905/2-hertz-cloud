name: Rollback AI Deploy

on:
  workflow_call:
    inputs:
      environment: # ê°’: "production" ë˜ëŠ” "stage"
        description: "ëŒ€ìƒ í™˜ê²½"
        required: true
        type: string

jobs:
  rollback:
    runs-on: ubuntu-latest

    steps:
      - name: Set environment variables
        run: |
          echo "ENVIRONMENT=${{ inputs.environment }}" >> $GITHUB_ENV
          echo "HOST=${{ inputs.environment == 'production' && secrets.PROD_SERVER_HOSTAI || secrets.STAGING_SERVER_HOSTAI }}" >> $GITHUB_ENV

      - name: Authenticate to GCP
        if: ${{ inputs.environment == 'production' }}
        uses: google-github-actions/auth@v1
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Authenticate to GCP (Stage)
        if: ${{ inputs.environment != 'production' }}
        uses: google-github-actions/auth@v1
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY_STAGING }}

      - name: Send rollback start notification
        run: |
          curl -H "Content-Type: application/json" \
            -X POST \
            -d "{\"content\": \"ğŸ”„ [AI ë¡¤ë°± ì‹œì‘] \`${{ inputs.environment }}\` í™˜ê²½ì—ì„œ ë¡¤ë°±ì„ ì‹¤í–‰í•©ë‹ˆë‹¤.\"}" \
            ${{ secrets.DISCORD_WEBHOOK_CICD_URL }}
            
      - name: SSH into server and rollback
        uses: appleboy/ssh-action@master
        with:
          host: ${{ env.HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            cd /home/deploy
            ./ai_deploy.sh --rollback || exit 1

      - name: Health check with retries
        env:
          HOST: ${{ env.HOST }}
          ENVIRONMENT: ${{ env.ENVIRONMENT }}
        run: |
          echo "ğŸ” AI ì„œë²„ í—¬ìŠ¤ì²´í¬ ì‹œì‘ (FastAPI Swagger docs)... ìµœëŒ€ 3íšŒ ì‹œë„í•©ë‹ˆë‹¤."
          for i in {1..3}; do
            echo "â±ï¸ ì‹œë„ $i: http://${{ env.HOST }}:8000/docs"
            if curl -sf http://${{ env.HOST }}:8000/docs; then
              echo "âœ… í—¬ìŠ¤ì²´í¬ ì„±ê³µ ğŸ‰"
              exit 0
            else
              echo "âš ï¸ í—¬ìŠ¤ì²´í¬ ì‹¤íŒ¨. 15ì´ˆ í›„ ì¬ì‹œë„..."
              sleep 15
            fi
          done

          echo "::error::âŒ 3íšŒ í—¬ìŠ¤ì²´í¬ ì‹¤íŒ¨ - ì„œë²„ê°€ ì •ìƒ ê¸°ë™ë˜ì§€ ì•ŠìŒ"
          exit 1

      - name: Send success notification
        if: success()
        run: |
          curl -H "Content-Type: application/json" \
            -X POST \
            -d "{\"content\": \"âœ… [AI ë¡¤ë°± ì™„ë£Œ] \`${{ inputs.environment }}\` í™˜ê²½\"}" \
            ${{ secrets.DISCORD_WEBHOOK_CICD_URL }}

      - name: Send failure notification
        if: failure()
        run: |
          curl -H "Content-Type: application/json" \
            -X POST \
            -d "{\"content\": \"âŒ [AI ë¡¤ë°± ì‹¤íŒ¨] \`${{ inputs.environment }}\` í™˜ê²½\"}" \
            ${{ secrets.DISCORD_WEBHOOK_CICD_URL }}
