name: Notify Discord on PR Merged to Develop

on:
  pull_request:
    types: [closed] # PRì´ ë‹«í˜”ì„ ë•Œ (ë³‘í•© í¬í•¨)
    branches:
      - develop # develop ë¸Œëžœì¹˜ë¡œ PR ë³‘í•© ì‹œ ê°ì§€

jobs:
  notify:
    if: github.event.pull_request.merged == true # ë³‘í•©ëœ ê²½ìš°ë§Œ ì‹¤í–‰
    runs-on: ubuntu-latest
    steps:
      - name: Send Discord notification (embed)
        run: |
          BASE_BRANCH="${{ github.event.pull_request.base.ref }}"
          PR_TITLE="${{ github.event.pull_request.title }}"
          PR_AUTHOR="${{ github.event.pull_request.user.login }}"
          PR_URL="${{ github.event.pull_request.html_url }}"
          PR_BODY="${{ github.event.pull_request.body }}"

          # ê¸°ë³¸ê°’ ì²˜ë¦¬
          if [[ -z "$PR_BODY" || "$PR_BODY" == "null" ]]; then
            PR_BODY="ë‚´ìš© ì—†ìŒ"
          fi

          # JSON ìƒì„±
          cat > payload.json << EOF
          {
            "embeds": [
              {
                "title": "âœ… PR Merged to \`$BASE_BRANCH\`! [PR ë§í¬]",
                "url": "$PR_URL",
                "description": "**Title:** $PR_TITLE\n**Author:** $PR_AUTHOR\n\nðŸ“ **Description:**\n\`\`\`\n$(echo "$PR_BODY" | sed 's/"/\\"/g')\n\`\`\`",
                "color": 3066993
              }
            ]
          }
          EOF

          # jqë¡œ JSON ê²€ì¦ ë° ì´ìŠ¤ì¼€ì´í”„ ì²˜ë¦¬
          cat payload.json | jq '.' > escaped_payload.json

          # ì›¹í›… ì „ì†¡
          curl -H "Content-Type: application/json" \
            -X POST \
            -d @escaped_payload.json \
            "${{ secrets.DISCORD_WEBHOOK_PR_URL }}"